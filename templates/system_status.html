<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>⚽ EURO_GOALS – System Status Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/static/icon_blue.png">
  <link rel="stylesheet" href="/static/css/style_dark.css">

  <style>
    body { color:#fff; background:#0d1117; font-family:'Segoe UI',Arial,sans-serif; }

    .led { display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;box-shadow:0 0 5px rgba(0,0,0,0.4); }
    .led.ok { background:#00ff66;box-shadow:0 0 6px #00ff66; }
    .led.fail { background:#ff3333;box-shadow:0 0 6px #ff3333; }
    .led.pending { background:#ffcc00;box-shadow:0 0 6px #ffcc00; }

    #alert-controls {
      display:flex;justify-content:center;gap:20px;
      background:#161616;padding:10px;border-radius:8px;
      border:1px solid #333;margin:15px auto;width:fit-content;
      box-shadow:0 0 6px rgba(0,255,174,0.1);
    }
    #alert-controls label {color:#ccc;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:6px;}
    #alert-controls input[type="checkbox"] {transform:scale(1.2);accent-color:#00ffae;cursor:pointer;}

    table {width:90%;margin:auto;border-collapse:collapse;}
    th,td {padding:8px 10px;text-align:center;border-bottom:1px solid #222;}
    th {background:#111927;color:#00b0ff;}
    tr.alert {background:rgba(255,0,0,0.08);}
    tr.normal:hover {background:rgba(255,255,255,0.05);}

    #diagnostics {
      display:none;
      margin:25px auto;
      padding:15px;
      max-width:850px;
      background:#161b22;
      border:1px solid #333;
      border-radius:10px;
      color:#ccc;
      box-shadow:0 0 10px rgba(0,255,174,0.1);
    }
    #diagnostics h3 { color:#00b0ff;margin-top:0;text-align:center; }
    #diagnostics ul { list-style:none;padding:0;margin:10px 0; }
    #diagnostics li { padding:6px 0; font-size:15px; }
    .oktxt { color:#00ff6a;font-weight:600; }
    .failtxt { color:#ff4444;font-weight:600; }
    .pendingtxt { color:#ffcc00;font-weight:600; }

    #health-btn {
      background:#00b0ff;
      color:#000;
      border:none;
      border-radius:6px;
      padding:8px 16px;
      font-weight:bold;
      cursor:pointer;
      transition:0.3s;
      display:block;
      margin:20px auto;
    }
    #health-btn:hover { background:#00e6a0; }

    #lastHealth {
      display:none;
      text-align:center;
      color:#00b0ff;
      margin-top:5px;
      font-size:14px;
      background:rgba(0,176,255,0.08);
      border-radius:6px;
      padding:4px 10px;
      width:fit-content;
      margin-left:auto;
      margin-right:auto;
    }

    /* 🟠 Asianconnect Panel */
    #asian-panel {
      background:#161b22;
      border:1px solid #333;
      border-radius:10px;
      width:340px;
      margin:30px auto;
      text-align:center;
      padding:20px;
      box-shadow:0 0 10px rgba(0,176,255,0.15);
    }
    #asian-panel h2 { color:#00b0ff; margin-bottom:10px; }
    #asian-indicator {
      display:inline-block;
      width:16px;
      height:16px;
      border-radius:50%;
      background:orange;
      box-shadow:0 0 6px orange;
      margin-bottom:10px;
    }
    #asian-time { color:#ccc; font-size:14px; display:block; margin-bottom:10px; }
    #asian-btn {
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:6px 12px;
      cursor:pointer;
      font-weight:bold;
    }
    #asian-btn:hover { background:#00e6a0; color:#000; }
  </style>
</head>

<body>

  <h1 style="text-align:center;">🖥️ System Status Panel</h1>

  <div id="alert-controls">
    <label><input type="checkbox" id="alertSmartMoney" checked> SmartMoney Alerts</label>
    <label><input type="checkbox" id="alertSystem" checked> System Alerts</label>
    <label><input type="checkbox" id="alertFeeds"> Feeds Alerts</label>
    <label><input type="checkbox" id="alertBrowser" checked> Browser Notifications</label>
  </div>

  <table id="statusTable">
    <thead>
      <tr>
        <th>Υπηρεσία</th>
        <th>Κατάσταση</th>
        <th>Τελευταία ενημέρωση</th>
        <th>Λεπτομέρειες</th>
      </tr>
    </thead>
    <tbody id="statusBody">
      <tr><td colspan="4">Φόρτωση δεδομένων...</td></tr>
    </tbody>
  </table>

  <div id="timestamp">Αναμονή δεδομένων...</div>
  <button id="health-btn">🔍 Εκτέλεση Health Check</button>
  <div id="lastHealth">🩺 Τελευταίος πλήρης έλεγχος:</div>
  <div id="diagnostics"></div>

  <!-- 🟠 Asianconnect API Status Panel -->
  <div id="asian-panel">
    <h2>Asianconnect API Status</h2>
    <div id="asian-indicator"></div>
    <span id="asian-time">Τελευταίος έλεγχος: undefined</span><br>
    <button id="asian-btn" onclick="checkAsianconnect()">Έλεγχος τώρα</button>
  </div>

  <div class="status-bar" style="text-align:center;margin-top:15px;">Αυτόματος έλεγχος κατάστασης κάθε 60 δευτερόλεπτα</div>

  <audio id="alertSound" src="/static/sounds/smartmoney_alert.mp3" preload="auto"></audio>
  <audio id="beepSound" src="/static/sounds/beep_soft.mp3" preload="auto"></audio>

  <script>
    // === Alert controls ===
    const controls=["alertSmartMoney","alertSystem","alertFeeds","alertBrowser"];
    controls.forEach(id=>{
      const cb=document.getElementById(id);
      const saved=localStorage.getItem(id);
      if(saved==="off")cb.checked=false;
      cb.addEventListener("change",()=>localStorage.setItem(id,cb.checked?"on":"off"));
    });

    const audio=document.getElementById("alertSound");
    const beep=document.getElementById("beepSound");
    const diagBox=document.getElementById("diagnostics");
    const lastHealth=document.getElementById("lastHealth");
    let lastStatuses={};

    document.getElementById("health-btn").addEventListener("click",()=>runHealthCheck(true));

    // === HEALTH CHECK (includes Asianconnect now) ===
    async function runHealthCheck(manual){
      try{
        const res=await fetch("/health");
        const data=await res.json();
        showDiagnostics(data,manual);
        if(data.components && data.components.Asianconnect){
          updateAsianPanel(data.components.Asianconnect);
        }
      }catch(err){
        diagBox.style.display="block";
        diagBox.innerHTML=`<h3>❌ Health check error</h3><p>${err}</p>`;
      }
    }

    // === Render Diagnostics ===
    function showDiagnostics(data,manual){
      const comp=data.components||{};
      let html=`<h3>🩺 Health Diagnostics (${data.timestamp})</h3>`;
      html+=`<p><b>Συνολικό status:</b> ${data.status}</p><ul>`;
      for(const [k,v] of Object.entries(comp)){
        let cls="oktxt";
        if(v==="FAIL")cls="failtxt";
        else if(v==="PENDING")cls="pendingtxt";
        html+=`<li><b>${k}</b>: <span class="${cls}">${v}</span></li>`;
      }
      html+=`</ul><p>${data.summary}</p>`;
      diagBox.innerHTML=html;
      diagBox.style.display="block";

      lastHealth.style.display="block";
      lastHealth.innerHTML=`🩺 Τελευταίος πλήρης έλεγχος: ${new Date().toLocaleTimeString("el-GR")}`;
      if(data.status==="FAIL"){ beep.currentTime=0; beep.play().catch(()=>{}); }
    }

    // === Asianconnect indicator ===
    function updateAsianPanel(status){
      const indicator=document.getElementById("asian-indicator");
      const time=document.getElementById("asian-time");
      if(status==="OK"){
        indicator.style.background="#00ff66";
        indicator.style.boxShadow="0 0 6px #00ff66";
      }else if(status==="FAIL"){
        indicator.style.background="#ff3333";
        indicator.style.boxShadow="0 0 6px #ff3333";
      }else{
        indicator.style.background="orange";
        indicator.style.boxShadow="0 0 6px orange";
      }
      time.textContent="Τελευταίος έλεγχος: "+new Date().toISOString().slice(0,19);
    }

    async function checkAsianconnect(){
      try{
        const res=await fetch("/check_asianconnect");
        const data=await res.json();
        updateAsianPanel(data.status==="ok"?"OK":"FAIL");
      }catch{
        updateAsianPanel("FAIL");
      }
    }

    // === Status Table Auto Update ===
    async function updateStatusTable(){
      try{
        const response=await fetch("/status_feed");
        const data=await response.json();
        const tbody=document.getElementById("statusBody");
        tbody.innerHTML="";
        let hasFail=false;

        data.forEach(service=>{
          const row=document.createElement("tr");
          row.className=service.status==="OK"?"normal":service.status==="PENDING"?"normal":"alert";
          const ledClass=service.status==="OK"?"ok":service.status==="PENDING"?"pending":"fail";

          if(service.status==="FAIL"&&lastStatuses[service.name]!=="FAIL"){
            hasFail=true;
            if(localStorage.getItem("alertSystem")==="on"){
              audio.currentTime=0;audio.play().catch(()=>{});
            }
          }
          lastStatuses[service.name]=service.status;

          row.innerHTML=`
            <td>${service.name}</td>
            <td><span class="led ${ledClass}"></span>${service.status}</td>
            <td>${service.timestamp}</td>
            <td>${service.details}</td>
          `;
          tbody.appendChild(row);
        });

        if(hasFail){ await runHealthCheck(false); }

        document.getElementById("timestamp").innerText="Τελευταίος έλεγχος: "+new Date().toLocaleTimeString("el-GR");
      }catch(err){
        console.error("Σφάλμα status_feed:",err);
      }
    }

    // === Initial load + intervals ===
    updateStatusTable();
    runHealthCheck(false);
    setInterval(updateStatusTable,60000);
    setInterval(runHealthCheck,120000);
  </script>

  <div class="footer" style="text-align:center;margin-top:25px;color:#777;">
    EURO_GOALS System Status v8.9m © 2025
  </div>
</body>
</html>
