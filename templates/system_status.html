<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>⚽ EURO_GOALS – System Status Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/static/icon_blue.png">
  <link rel="stylesheet" href="/static/css/style_dark.css">

  <style>
    /* 🔘 LED INDICATORS */
    .led {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
    }
    .led.ok { background-color: #00ff66; box-shadow: 0 0 6px #00ff66; }
    .led.fail { background-color: #ff3333; box-shadow: 0 0 6px #ff3333; }
    .led.pending { background-color: #ffcc00; box-shadow: 0 0 6px #ffcc00; }

    /* ⚙️ ALERT CONTROL BAR */
    #alert-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      background-color: #161616;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      margin: 15px auto;
      width: fit-content;
      box-shadow: 0 0 6px rgba(0,255,174,0.1);
    }

    #alert-controls label {
      color: #ccc;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #alert-controls input[type="checkbox"] {
      transform: scale(1.2);
      accent-color: #00ffae;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>🖥️ System Status Panel</h1>

  <!-- 🔔 Alert Control Bar -->
  <div id="alert-controls">
    <label><input type="checkbox" id="alertSmartMoney" checked> SmartMoney Alerts</label>
    <label><input type="checkbox" id="alertSystem" checked> System Alerts</label>
    <label><input type="checkbox" id="alertFeeds"> Feeds Alerts</label>
    <label><input type="checkbox" id="alertBrowser" checked> Browser Notifications</label>
  </div>

  <!-- Status Table -->
  <table id="statusTable">
    <thead>
      <tr>
        <th>Υπηρεσία</th>
        <th>Κατάσταση</th>
        <th>Τελευταία ενημέρωση</th>
        <th>Λεπτομέρειες</th>
      </tr>
    </thead>
    <tbody id="statusBody">
      <tr><td colspan="4">Φόρτωση δεδομένων...</td></tr>
    </tbody>
  </table>

  <div id="timestamp">Αναμονή δεδομένων...</div>
  <div class="status-bar">Αυτόματος έλεγχος κατάστασης κάθε 60 δευτερόλεπτα</div>

  <audio id="alertSound" src="/static/sounds/smartmoney_alert.mp3" preload="auto"></audio>

  <script>
    // 🔧 Αποθήκευση / Ανάκτηση επιλογών
    const controls = ["alertSmartMoney", "alertSystem", "alertFeeds", "alertBrowser"];
    controls.forEach(id => {
      const checkbox = document.getElementById(id);
      const saved = localStorage.getItem(id);
      if (saved === "off") checkbox.checked = false;

      checkbox.addEventListener("change", () => {
        localStorage.setItem(id, checkbox.checked ? "on" : "off");
      });
    });

    const audio = document.getElementById("alertSound");
    let lastStatuses = {};

    async function updateStatusTable() {
      try {
        const response = await fetch("/status_feed");
        const data = await response.json();
        const tbody = document.getElementById("statusBody");
        tbody.innerHTML = "";

        data.forEach(service => {
          const row = document.createElement("tr");
          row.className = service.status === "OK" ? "normal" : 
                          service.status === "PENDING" ? "normal" : "alert";

          let ledClass = "fail";
          if (service.status === "OK") ledClass = "ok";
          else if (service.status === "PENDING") ledClass = "pending";

          // Αν η κατάσταση άλλαξε σε FAIL → ήχος (μόνο αν ενεργό)
          if (service.status === "FAIL" && lastStatuses[service.name] !== "FAIL") {
            if (localStorage.getItem("alertSystem") === "on") {
              audio.currentTime = 0;
              audio.play().catch(()=>{});
            }

            if (localStorage.getItem("alertBrowser") === "on" && "Notification" in window) {
              if (Notification.permission === "granted") {
                new Notification(`⚠️ ${service.name} FAILURE`, {
                  body: service.details,
                  icon: "/static/icon_red.png"
                });
              } else if (Notification.permission !== "denied") {
                Notification.requestPermission();
              }
            }
          }

          lastStatuses[service.name] = service.status;

          row.innerHTML = `
            <td>${service.name}</td>
            <td><span class="led ${ledClass}"></span>${service.status}</td>
            <td>${service.timestamp}</td>
            <td>${service.details}</td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById("timestamp").innerText =
          "Τελευταίος έλεγχος: " + new Date().toLocaleTimeString("el-GR");

      } catch (err) {
        console.error("Σφάλμα φόρτωσης κατάστασης:", err);
        const tbody = document.getElementById("statusBody");
        tbody.innerHTML = `<tr class="alert"><td colspan="4">❌ Αποτυχία φόρτωσης δεδομένων</td></tr>`;
        document.getElementById("timestamp").innerText = "❌ Πρόβλημα επικοινωνίας με /status_feed";
      }
    }

    updateStatusTable();
    setInterval(updateStatusTable, 60000);
  </script>

  <div class="footer">
    EURO_GOALS System Status v8.9i © 2025
  </div>

</body>
</html>
